
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>PyDay - Containers</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/dist/reset.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/dist/reveal.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/dist/theme/black.css" id="theme">
        <link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/a11y-light.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata|Roboto:300,400,500|Work+Sans:400,700">
		<style>
			.reveal {
                background: #0a0c0f;
				font-family: "Work Sans", sans-serif;
                color: white;
			}

			.reveal .slides section, .reveal table {
				text-align: left;
				font-size: smaller;
                color: white;
			}

			.reveal pre {
				background-color: #f5f5f5;
				width: 100%;
				border: 1px solid #ccc;
				border-radius: 4px;
				box-shadow: none;
			}

            .reveal section li {
                margin-bottom: 12px;
            }

			.reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5, .reveal h6 {
				font-family: "Roboto", sans-serif;
                font-weight: 500;
				color: white;
                text-transform: none;
			}

			.reveal section.heading-only {
				text-align: left;
				padding-top: 5%;
			}

            .no-code-badge .code-badge {
                display: none;
            }

            .code-badge-language {
                display: none;
            }

			.reveal h3 {
				margin-bottom: 40px;
			}

            .smaller {
                font-size: smaller;
            }

            code {
                padding: 2px 4px;
                font-size: 90%;
                color: #0072c1;
                background-color: #f9f2f4;
                border-radius: 4px;
            }

            p.padded {
                margin-top: 32px;
            }

            section .row {
                display: flex;
            }

            section .column {
                flex: 48%;
                margin: 10px;
            }

            .aka {
                font-family: "Roboto Mono", monospace;
                background-color: #1c6192;
                color: white;
                padding: 8px;
                border-radius: 6px;
                display: inline-block;
                margin-top: 12px;
                margin-bottom: 12px;
            }

			@media print
			{
				.no-print, .no-print *
				{
					display: none !important;
				}
			}

		</style>
	</head>
    <body>
    <div class="reveal">
        <div class="slides">

            <section class="heading-only" data-background-image="background_headingonly.png">
                <h1>Containerizing Python<br>Web Apps with Docker
                </h1>

                <h2><span class="aka">aka.ms/pyday-containers</span></h2>

                <div class="no-print" style="text-align: left; margin-top: 100px; font-size: 70%;">
                    Tips for navigating the slides:<br>
                    <ul>
                        <li>Use the left-side menu for a table of contents.</li>
                        <li>Press the copy icon on the upper right of code blocks to copy the code</li>
                        <li>Visit <a href="?print-pdf" target="_blank">this link</a> for a nice printable version</li>
                    </ul>
                </div>

                <aside class="speaker-notes">
                </aside>
            </section>
            
            <section>
                <h3>What we'll cover</h3>

                <img src="../media/BIT_PUBLIC_SPEAKING.svg" alt="Bit (the raccoon) lecturing" width="300" style="float:right;">
                <ul style="margin-top:20px; font-size:40px; line-height: 2em;">
                    <li>Intro to Containers
                    <li>Containerizing Flask
                    <li>Hosting containers on Azure
                    <li>Containers with databases
                    <li>Hosting containers on Azure with databases
                </ul>
            </section>

            <section class="heading-only"  data-background-image="background_headingonly.png">
                <h2>Docker</h2>
           </section>

            <section>
                <h3>The goal of containers</h3>

                <p>A container is a standard way to package an application
                    with all of its dependencies, so that it can be run <em>anywhere</em>.</p>
                <img src="container_ship.jpg" alt="Container ship at port" width="660" style="border: 1px solid white;">
            </section>

            <section>
                <h3>Docker overview</h3>

                <p>The Docker engine runs multiple Docker containers,
                    where each container is an isolated environment.</p>

                <img src="containers.svg" alt="Diagram of two Docker containers running on top of one Docker engine running on top of an Operating System on top of Hardware" width="700">
            
            </section>

            <section>
                <h3>Docker overview example</h3>

                <p>Each container can be a very different environment,
                    with binaries and libraries dependent on the application.</p>

                <img src="containers-example.svg" alt="Diagram of two Docker containers, one with Python/PostgreSQL/Django, the other with Ruby/MySQL/Rails" width="700">
            
            </section>

            <section>
                <h3>The benefits of containers</h3>

                <ul>
                    <li><strong>Environment consistency</strong>:  Ensure that 
                        the developer environment, test environment, staging environment,
                        and production environments are the same.
                    <li><strong>Application portability</strong>: Easy to run
                        the application on new hardware if old hardware fails
                        or if application needs to scale.
                    <li><strong>Efficient hardware use</strong>: A machine
                        can run multiple containers to make optimal use of its resources.
                </ul>
                <p>
            </section>

            <section>
                <h3>Docker images</h3>

                <p>A <strong>container image</strong> is a software package that includes
                    everything needed to run an application.
                    <br>
                    A <strong>container</strong> is a running instance of a container image. 
                </p>
                <img src="images.svg" alt="Diagram of two Docker images, one with Python/PostgreSQL/Django, the other with Ruby/MySQL/Rails, and one running Django container" width="650">
            
            </section>
            
            <section>
                <h3>Docker images</h3>

                <p>Multiple containers can be run from the same image. 
                </p>
                <img src="images-two.svg" alt="Diagram of two Django containers running on top of a single Docker engine" width="700">
            
            </section>

            <section>
                <h3>Image registries</h3>

                <p>A <strong>registry</strong> is a place to store and share images.</p>

                <p>Commonly used image registries:</p>
                    <ul>
                        <li><a target="_blank" href="https://hub.docker.com/">Docker Hub</a>: contains many images, including official images for python, postgres, Unix systems, etc.
                        <li><a target="_blank" href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry">GitHub container registry</a>
                        <li><a target="_blank" href="https://azure.microsoft.com/en-us/services/container-registry/">Azure container registry</a>
                        <li><a target="_blank" href="https://aws.amazon.com/ecr/">AWS container registry</a>
                        <li><a target="_blank" href="https://cloud.google.com/container-registry">Google Cloud container registry</a>
                    <br>
            </section>

            <section>
                <h3>Image layers</h3>

                <p>A container image often starts off with a <strong>base image</strong>, 
                    and then adds layers on top of it.</p>
                
                <p>For example:</p>
                    <ul>
                        <li>Base image: Ubuntu 20.04
                        <li>Layer 1: Python 3.9
                        <li>Layer 2: Flask 2.0
                        <li>Layer 3: Your app
                    </ul>
                <p>Docker can cache each layer, which improves performance.</p>
            </section>

            <section class="heading-only"  data-background-image="background_headingonly.png">
                <h2>Productionizing<br>
                Flask apps</h2>

                <img src="../media/BIT_PYTHON.svg" alt="Bit (the raccoon) in front of a computer and Python logo" width="400">
            </section>

            
            <section>
                <h3>Sample Flask app </h3>

                <pre style="font-size:0.7em;"><code data-trim data-noescape class="python">
                from flask import Flask, render_template, request

                app = Flask(__name__, template_folder='templates', static_folder='static')
                
                @app.route('/')
                def index():
                   return render_template('index.html')

                @app.route('/hello')
                def hello():
                    return render_template('hello.html', name=request.args.get('name'))
                </code></pre>

                <p>
                    üë©üèæ‚Äçüíª Want to follow along? Starter repo: <br>
                    <span class="aka">aka.ms/flask-docker-starter</span><br>
                    Code: <a class="smaller" target="_blank" href="https://github.com/pamelafox/simple-flask-server-container-starter">github.com/pamelafox/simple-flask-server-container-starter</a>
                </p>

            </section>


            <section>
                <h3>Follow along with me!</h3>

                <p>Open this project:<br>
                    <a target="_blank" href="https://github.com/pamelafox/simple-flask-server-container-starter">github.com/pamelafox/simple-flask-server-container-starter
                    
                    <span class="aka">aka.ms/flask-docker-starter</span>
                    </a>
                </p>

                <p>Using either: 
                    <img src="screenshot_codespacetab.png" alt="Screenshot of GitHub Codespaces tab" width="400" style="float:right;">
                    <ul style="float:left; width: 55%">
                    <li>GitHub Codespaces ‚û°Ô∏è
                    <li>VS Code with Dev Containers extension
                    <li>Local dev with virtual environment
                    </ul>
                </p>
            </section>
            
            <section>
                <h3>Running Flask app locally</h3>

                <p>Using the built-in Flask server:</p>
                <pre style="font-size:0.9em;"><code data-trim data-noescape class="bash">
                python3 -m flask run --port 50505 --debug
                </code></pre>
                <br>
                <p class="fragment">‚ö†Ô∏è The dev server is <strong>not recommended</strong> for production use.</p>
            </section>

            <section>
                <h3>Running Flask with gunicorn</h3>

                <p>Gunicorn is a production-level server
                    that can run multiple worker processes.</p>

                <p>Add <code>gunicorn</code> to <code>requirements.txt</code>:</p>
                <pre style="font-size:0.7em; margin-top:0px;"><code data-trim data-noescape class="shell">
                Flask==2.2.3
                gunicorn==20.1.0
                </code></pre>

                <p class="padded">Use <code>gunicorn</code> to run Flask app with multiple workers:</p>
                <pre style="font-size:0.7em; margin-top:0px;"><code data-trim data-noescape class="shell">
                python3 -m gunicorn app:app --workers 4 --bind 0.0.0.0:50505
                </code></pre>
            </section>

            <section>
                <h3>Configuring gunicorn</h3>

                <p>Gunicorn can be configured with a <code>gunicorn.conf.py</code> file:</p>

                <pre style="font-size:0.7em; margin-top:0px;"><code data-trim data-noescape class="python">
                import multiprocessing
                    
                max_requests = 1000
                max_requests_jitter = 50
                log_file = "-"
                bind = "0.0.0.0:50505"
                
                workers = (multiprocessing.cpu_count() * 2) + 1
                threads = workers
                timeout = 120
                </code></pre>

                <p>The run command can be simplified to:</p>
                <pre style="font-size:0.7em; margin-top:0px;"><code data-trim data-noescape class="shell">
                python3 -m gunicorn app:app
                </code></pre>

            </section>

            <section class="heading-only"  data-background-image="background_headingonly.png">
                <h2>Containerizing<br>
                Flask apps</h2>

                <img src="../media/DATA_BIT.svg" alt="Bit (the raccoon) as Neo from the Matrix" width="400">
            </section>

            <section>
                <h3>Containerization steps</h3>

                <ol>
                    <li><strong>Write</strong> a Dockerfile
                    <li><strong>Build</strong> image from Dockerfile
                    <li><strong>Run</strong> container using built image
                </ol>  
            </section>

            <section>
                <h3>Dockerfile format</h3>

                <p>A Dockerfile includes:</p>

                <table style="font-size: smaller;">
                    <tr>
                        <td>The base or parent image*
                        <td><code>FROM python:3.11</code>
                    <tr>
                        <td>Additional software
                        <td><code>RUN pip3 install Flask gunicorn</code>
                    <tr><td>Application code
                        <td><code>WORKDIR /code</code><br>
                            <code>COPY . .</code>
                    <tr><td>Services to expose (storage/network)
                        <td><code>EXPOSE 50505</code>
                    <tr><td>Command to run upon launching container
                        <td><code>ENTRYPOINT ["gunicorn", "-c", "gunicorn.conf.py", "app:app"]</code>
                </table>

                <p class="smaller">*Find existing images in registries, like <a target="_blank" href="https://hub.docker.com/search?image_filter=official&q=">Docker Hub</a>.</p>
            </section>
            

            <section>
                <h3>Dockerfile for Flask</h3>

                <p>A complete file:</p>
                <pre style="font-size:0.7em;"><code data-trim data-noescape class="docker">
                FROM python:3.11

                WORKDIR /code

                COPY requirements.txt .
                RUN pip3 install -r requirements.txt

                COPY . .

                EXPOSE 50505

                ENTRYPOINT ["gunicorn", "-c", "gunicorn.conf.py", "app:app"]
                </code></pre>

                <p class="smaller">üìñ Learn more: <a target="_blank" href="https://gabnotes.org/docker-images-layers-and-cache/">Docker images layer and cache</a></p>
            </section>

            <section>
                <h3>Add a dockerignore file</h3>

                <p>Prevent unnecessary files from being copied to the image:</p>
                <pre style="font-size:0.7em;"><code data-trim data-noescape class="docker">
                .git*
                .venv/
                **/*.pyc
                __pycache__/
                </code></pre>

            </section>

            <section>
                <h3>Building the image</h3>

                <p>Using the <code>docker build</code> command:</p>
                <pre style="font-size:0.7em;"><code data-trim data-noescape class="bash">
                docker build --tag flaskapp .
                </code></pre>

                <p class="padded" style="margin-bottom:0px">Using the VS Code Docker extension:</p>
                <img src="vsc-docker.png" alt="Screenshot of Docker extension in Visual Studio Code" width="600">

            </section>

            <section>
                <h3>Running the container</h3>

                <p>Using the <code>docker run</code> command:</p>
                <pre style="font-size:0.7em;"><code data-trim data-noescape class="bash">
                docker run --publish 50505:50505 flaskapp
                </code></pre>
                
                <p class="padded" style="margin-bottom:0px">Using VS Code Docker extension or Docker Desktop:</p>
                <img src="screenshot_vscode_run.png" alt="Screenshot of Docker images list with run option in context menu" height="300">
                <img src="docker-run.png" alt="Screenshot of Docker images list with run button next to one of them" height="300">
            </section>


            <section class="heading-only" data-background-image="background_headingonly.png">
                <h2>Hosting containers<br>
                on Azure!</h2>

                <img src="../media/BIT_AZURE.png" alt="Bit (the raccoon) in the clouds next to Azure logo" width="400">

            </section>


            <section>
                <h3>Azure hosting options</h3>
                
                <style>
                table.deploy-stack {
                    border-spacing: 30px; 
                    border-collapse: separate;
                    border: 0px;
                }

                table.deploy-stack th, table.deploy-stack td {
                    font-size: 20px;
                    border-bottom: 0px none;
                    border-radius: 12px;
                    text-align: center;
                    vertical-align: middle;
                    padding: 8px;
                }
                </style>
                <table class="deploy-stack">
                    <tr>
                        <th>Cloud
                        <td colspan="4" style="background-color:#767676;">Azure
                    </tr>
                    <tr>
                        <th>Environment
                        <td colspan="2" style="background-color:#0070c0; color: white;">Containers
                        <td colspan="2" style="background-color:#0070c0; color: white;">PaaS
                    </tr>
                    <tr>
                        <th>
                        <td style="background-color: #008850; color: white;">Azure Kubernetes Service
                        <td style="background-color: #0070c0; color: white;">Container Management
                        <td style="background-color: #008850; color: white;">Azure App Service
                        <td style="background-color: #0070c0; color: white;">Serverless
                        
                    </tr>
                    <tr>
                        <th>
                        <td>
                        <td style="background-color: #008850; color: white;">Azure Container Apps
                        <td>
                        <td style="background-color: #008850; color: white;">Azure Functions
                    </tr> 
                </table>
                <p class="smaller">For hosting containers, 
                    <span style="background-color: #008850; color: white; padding: 3px 6px; border-radius: 6px;">Kubernetes Service</span>,
                    <span style="background-color: #008850; color: white; padding: 3px 6px; border-radius: 6px;">Container Apps</span>, and
                    <span style="background-color: #008850; color: white; padding: 3px 6px; border-radius: 6px;">App Service (BYOC)</span> 
                    are all good options.</p>

                <br>
                <p class="smaller">üìñ Learn more: <a target="_blank" href="https://learn.microsoft.com/en-us/azure/container-apps/compare-options">Comparing Container Apps with other Azure container options</a></p>
            </section>

            <section>
                <h3>Hosting on Azure Container Apps</h3>

                <p>A <strong>Container Apps Environment</strong>
                    manages a <strong>Container App</strong>.</p>

                <img src="diagram_azurecontainerapp.png" alt="Flask container architecture diagram: Azure Container Apps Environment, Azure Container App, Azure Container Registry, Container, and PostgreSQL Server">
                
                <p>
                    The <strong>Container App</strong> pulls its image from an <strong>Azure Container Registry</strong>.
                    (Other registries are also possible)
                </p>
            </section>

            <section>
                <h3>Follow along with me!</h3>

                <p>Open this project:<br>
                    <a target="_blank" href="https://github.com/pamelafox/simple-flask-server-container">
                        github.com/pamelafox/simple-flask-server-container
                    <br>
                    <span class="aka">aka.ms/flask-docker-deploy</span>
                    </a>
                </p>

                <p>Using either: 
                    <img src="screenshot_codespacetab.png" alt="Screenshot of GitHub Codespaces tab" width="400" style="float:right;">
                    <ul style="float:left; width: 50%">
                    <li>GitHub Codespaces ‚û°Ô∏è
                    <li>VS Code with Dev Containers extension
                    </ul>
                </p>
            </section>

            <section>
                <h3>Deploying to ACA with Azure CLI</h3>

                <ol class="smaller">
                    <li>Get a free Azure account and subscription.
                    <li>Install the Azure CLI (already installed in Dev Container).
                    <li>Login to your Azure account:
                    <pre style="font-size:0.8em;"><code data-trim data-noescape class="bash">
                    az login
                    </code></pre>
                    <li>Create a resource group:</p>
                    <pre style="font-size:0.8em;"><code data-trim data-noescape class="bash">
                    az group create --name flaskapp-rg --location eastus
                    </code></pre>

                    <li>Create resources and deploy the app:</p>

                    <pre style="font-size:0.8em;"><code data-trim data-noescape class="bash">
                    az containerapp up --resource-group flaskapp-rg --name flaskapp-aca \
                        --ingress external --target-port 50505 --source .
                    </code></pre>
                </ol>
            </section>

            <section>
                <h3>Deploying to ACA with AZD</h3>

                <p>Using this repo (with Bicep files in infra folder):<br>
                    <a target="_blank" href="https://github.com/pamelafox/simple-flask-server-container">
                        github.com/pamelafox/simple-flask-server-container
                    <br>
                    <span class="aka">aka.ms/flask-docker-deploy</span>
                    </a>
                </p>

                <ol class="smaller">
                    <li>Get a free Azure account and subscription.
                    <li>Install the Azure Developer CLI (already installed in Dev Container).
                    <li>Login to your Azure account:
                    <pre style="font-size:0.8em;"><code data-trim data-noescape class="bash">
                    azd auth login
                    </code></pre>
                    <li>Create resources and deploy the app:
                    <pre style="font-size:0.8em;"><code data-trim data-noescape class="bash">
                    azd up
                    </code></pre>
                </ol>
            </section>


            <section>
                <h3>Clean up the resources</h3>

                <p>Azure Container Apps pricing is consumption based,
                    but Azure Container Registry pricing is hourly based.</p>

                <p>When you no longer need the resources, delete them! üóëÔ∏è </p>

                <p>Find the resource group in the Portal and delete it there:</p>
                <img src="screenshot_delete.png" alt="Delete resource group" width="800">

                <p>If you used <code>azd</code>, an alternative is to call <code>azd down</code>.</p>

            </section>

            <section class="heading-only"  data-background-image="background_headingonly.png">
                <h2>Accessing databases<br>
                    from containers
                </h2>

                <img src="../media/BIT_DEV.svg" alt="Bit (the raccoon) next to a bunch of monitors" width="400">
            </section>

            <section>
                <h3>Sample Flask app with DB</h3>

                <pre style="font-size:0.7em;"><code data-trim data-noescape class="python">
                @app.route('/surveys', methods=['GET'])
                def surveys_list_page():
                    return render_template('surveys_list.html', surveys=Survey.query.all())
                
                @app.route('/surveys/<int:survey_id>', methods=['GET'])
                def survey_page(survey_id):
                    survey = Survey.query.where(Survey.id == survey_id).first()
                    answers = Survey.query.where(Answer.survey==survey_id)
                    return render_template('survey_details.html', survey=survey, answers=answers, already_voted='survey_id' in request.cookies)
                </code></pre>

                <p class="smaller">
                    üëÄ Demo: 
                    <a target="_blank" href="https://flasksurveys-xvmcme-containerapp.redcoast-67e33cd1.eastus.azurecontainerapps.io/surveys/3">
                        <span class="aka">aka.ms/flask-surveys-docker</span>
                    </a>
                </p>

                <p class="smaller">
                    üë©üèæ‚Äçüíª Want to follow along? Starter repo: <br>
                    <span class="aka">aka.ms/flask-db-container</span><br>
                    Code: <a class="smaller" target="_blank" href="https://github.com/pamelafox/flask-surveys-container-app">github.com/pamelafox/flask-surveys-container-app</a>
                </p>

            </section>


            <section>
                <h3>Follow along with me!</h3>

                <p>Open this project:<br>
                    <a class="smaller" target="_blank" href="https://github.com/pamelafox/flask-surveys-container-app">
                    github.com/pamelafox/flask-surveys-container-app
                    </a>
                    <span class="aka">aka.ms/flask-db-container</span>
                </p>

                <p>Using either: 
                    <img src="screenshot_codespacetab.png" alt="Screenshot of GitHub Codespaces tab" width="400" style="float:right;">
                    <ul style="float:left; width: 60%">
                    <li>GitHub Codespaces ‚û°Ô∏è ‚û°Ô∏è ‚û°Ô∏è
                    <li>VS Code with Dev Containers extension
                    <li>Local editor with virtual environment
                    </ul>
                </p>
            </section>
            

            <section>
                <h3>Data persistence in containers</h3>
            
                <p>Data <em>can</em> be written to a container's file system, but:</p>

                <ul>
                    <li>Removing a container removes the data
                    <li>Container data is difficult to move between environments
                    <li>Container storage drives are less performant
                </ul>
                
                <p>If you need to persist data, you should store it <em>outside</em> the container.</p>
                
            </section>

            <section>
                <h3>Docker volumes</h3>

                <p>A <strong>volume</strong>  is a directory on the host machine that is mapped to a directory in the container.
                </p>
                
                <img alt="Diagram of Docker container and Docker volumes inside the File System" src="volumes.svg" width="450">

                <p>When developing with databases <em>locally</em>, use a volume to store the data for the database.</p>
            </section>

            <section>
                <h3>Running PostgreSQL with Docker</h3>

                <p>Create a volume:</p>
                <pre style="font-size:0.7em; margin-top: -10px;"><code data-trim data-noescape class="bash">
                docker volume create postgres-data
                </code></pre>

                <p class="padded">Create a network for the containers to communicate over:</p>
                <pre style="font-size:0.7em; margin-top: -10px;"><code data-trim data-noescape class="bash">
                docker network create postgres-net
                </code></pre>

                <p class="padded">Run a PostgreSQL container with the volume and network:</p>
                <pre style="font-size:0.7em; margin-top: -10px;"><code data-trim data-noescape class="bash">
                docker run --rm -d --name db --network postgres-net \
                    -v postgres-data:/var/lib/postgresql/data \
                    -e POSTGRES_USER=app_user -e POSTGRES_PASSWORD=app_password \
                    postgres
                </code></pre>

                <p class="smaller">From <a target="_blank" href="https://docs.docker.com/language/dotnet/develop/#run-a-database-in-a-container">
                    Docker tutorial: Run a database in a container</a></p>
            </section>

            <section>
                <h3>Connecting the app to the DB</h3>

                <p>Set environment variables for the database connection:</p>

                <pre style="font-size:0.7em; margin-top: -10px;"><code data-trim data-noescape class="bash">
                DBHOST=db
                DBNAME=postgres
                DBUSER=app_user
                DBPASS=app_password
                </code></pre>

                <p>Build the container:</p>
                <pre style="font-size:0.7em;"><code data-trim data-noescape class="bash">
                docker build --tag flasksurveyscontainerapp src/
                </code></pre>

                <p class="padded">Run the app container over the same network:</p>

                <pre style="font-size:0.7em; margin-top: -10px;"><code data-trim data-noescape class="bash">
                docker run --rm --name flask-db-app --network postgres-net \
                    --env-file .env -p 50505:50505 \
                    flasksurveyscontainerapp
                </code></pre>
            </section>

            <section>
                <h3>Docker compose</h3>

                <p>Docker compose is a tool for multi-container Docker apps.<br>
                    <code>docker-compose.yaml</code> defines the services that make up your app:
                </p>

                <pre style="font-size:0.45em; height:480px;"><code data-trim data-noescape class="bash">
                services:
                    db:
                        image: postgres
                        restart: always
                        environment:
                            POSTGRES_PASSWORD: ${DBPASS:?database password not set}
                            POSTGRES_USER: ${DBUSER:?database user not set}
                            POSTGRES_DB: ${DBNAME:?database name not set}
                        volumes:
                            - postgres-data:/var/lib/postgresql/data
                        healthcheck:
                            test: ["CMD-SHELL", "pg_isready -U ${DBUSER} -d ${DBNAME}"]
                            interval: 5s
                            timeout: 5s
                            retries: 5
                    app:
                        build:
                            context: .
                        ports:
                            - 5000:5000
                        depends_on:
                            db:
                                condition: service_healthy
                    volumes:
                        postgres-data:
                </code></pre>
            </section>

            <section>
                <h3>Run multiple containers</h3>

                <p>Run the app and database containers:</p>

                <pre style="font-size:0.9em;"><code data-trim data-noescape class="bash">
                docker-compose up
                </code></pre>

            </section>

            <section class="heading-only" data-background-image="background_headingonly.png">
                <h2>Hosting containers<br>
                    <em>with databases</em><br>
                on Azure!</h2>

                <img src="../media/BIT_AZURE.png" alt="Bit (the raccoon) in the clouds next to Azure logo" width="400">

            </section>

            <section>
                <h3>Storage in container apps</h3>

                <p>For temporary storage, you can write to file system or
                have an <a target="_blank" href="https://learn.microsoft.com/en-us/azure/container-apps/storage-mounts?pivots=azure-cli#temporary-storage">
                    ephemeral volume</a> in a container app.
                </p>

                <p class="fragment">For permanent storage, you can mount
                    <a target="_blank" href="https://learn.microsoft.com/en-us/azure/container-apps/storage-mounts?pivots=azure-cli#azure-files">Azure Files</a>
                    but performance is too limited to be useful for a database.
                </p>

                <p class="fragment">
                Best approach for Azure: <br>
                Use a managed database service <em>outside</em> the container.
                </p>
            </section>

            <section>
                <h3>Azure managed databases services</h3>

                <style>
                .fragment.background-green {
                    background-color: transparent;
                }
                .fragment.background-green.visible {
                    background-color: #04865a;
                }
                </style>

                <p>These are just some of the options:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Option</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Azure CosmosDB
                            <td>Distributed database with multiple APIs, including MongoDB and Cassandra.
                        </tr>
                        <tr>
                            <td>Azure Cosmos DB for PostgreSQL</td>
                            <td>Distributed database using PostgreSQL and the Citus extension. Can scale vertically and horizontally.
                            </td>
                          </tr>
                        <tr class="fragment custom background-green">
                            <td>Azure Database for PostgreSQL ‚Äì Flexible Server</td>
                            <td>Fully managed service with vertical scaling.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section>
                <h3>Goal: Containerized App with PostgreSQL access</h3>

                <img src="diagram_azurecontainerapp_postgres.png" alt="Architecture diagram: Azure Container App with PostgreSQL access" width="800" style="border: 10px solid white;">
            </section>

            <section>
                <h3>Deploying to ACA + PG with AZD</h3>

                <p>Using this repo (with Bicep files in infra folder):<br>
                    <a target="_blank" href="https://github.com/pamelafox/flask-surveys-container-app">
                        https://github.com/pamelafox/flask-surveys-container-app
                    <br>
                    <span class="aka">aka.ms/flask-db-container</span>
                    </a>
                </p>

                <ol class="smaller">
                    <li>Get a free Azure account and subscription.
                    <li>Install the Azure Developer CLI (already installed in Dev Container).
                    <li>Login to your Azure account:
                    <pre style="font-size:0.8em;"><code data-trim data-noescape class="bash">
                    azd auth login
                    </code></pre>
                    <li>Create resources and deploy the app:
                    <pre style="font-size:0.8em;"><code data-trim data-noescape class="bash">
                    azd up
                    </code></pre>
                </ol>
            </section>


            <section>
                <h3>Clean up the resources</h3>

                <p>Azure Container App has usage-based pricing. Both Azure Container Registry and PostgreSQL flexible server have hourly-based pricing.</p>

                <p>When you no longer need the resources, delete them! üóëÔ∏è </p>

                <p>Find the resource group in the Portal and delete it there:</p>
                <img src="screenshot_delete.png" alt="Delete resource group" width="800">

                <p>If you used <code>azd</code>, an alternative is to call <code>azd down</code>.</p>

            </section>

            <section>
                <h3>More containerized Python templates</h3>

                <p>Find lots of examples in the AZD templates gallery:
                <br>
                <a class="smaller" target="_blank" href="https://azure.github.io/awesome-azd/?operator=AND&tags=python&tags=aca">
                https://azure.github.io/awesome-azd/?operator=AND&tags=python&tags=aca
                </a>
                </p>

                <img src="screenshot_azdcontainers.png" alt="Screenshot of AZD templates gallery" width="600">
               

            </section>

            <section>
                <h3>More resources</h3>

                <img src="../media/BIT_COWORKING.png" alt="Raccoons with laptops" width="35%" style="float:right;">

                <ul style="float:left; width: 60%; margin-bottom: 40px;">
                    <li><a target="_blank" href="https://learn.microsoft.com/en-us/azure/developer/python/containers-in-azure-overview-python">Python Container Apps in Azure</a>
                    <li><a target="_blank" href="https://learn.microsoft.com/en-us/azure/developer/python/quickstarts-app-hosting">Hosting Python apps on Azure</a>
                    <li><a target="_blank" href="https://code.visualstudio.com/docs/python/python-tutorial">Getting Started with Python in VS Code</a>
                    <li><a target="_blank" href="https://techcommunity.microsoft.com/t5/educator-developer-blog/how-to-optimize-your-codespaces-pro-tips-for-managing-quotas/ba-p/3712032">How to optimize your Codespaces</a>
                </ul>

                <p>üìã Answer our survey! <br>
                    <span class="aka">aka.ms/pydaysurvey</span>
                </p>
                <br>
                <p>üôèüèª Thank you for attending! üôèüèæ</p>
            </section>

            <section class="heading-only"  data-background-image="background_headingonly.png">
                <h2>Any questions?</h2>
                <img src="../media/BIT_STUDENTS.svg" alt="A bunch of raccoon students with computers" width="400">
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/plugin/highlight/highlight.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlightjs-badge@0.1.9/highlightjs-badge.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js-menu@2.1.0/menu.js"></script>
    <script>
        Reveal.initialize({
            width: 1280,
            height: 720,
            hash: true,
            center: false,
            slideNumber: true,
            showNotes: false,
            margin: 0.1,
            preloadIframes: true,
            autoPlayMedia: true,
            plugins: [ RevealHighlight, RevealMenu ],
            pdfSeparateFragments: true
        });
        window.highlightJsBadge();
    </script>
    </body>
</html>